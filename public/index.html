<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>PIX Mercado Pago Produção</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 400px; margin: 40px auto; text-align: center; }
    input, button { padding: 10px; margin: 10px; width: 90%; }
    #qr img { margin-top: 20px; max-width: 300px; }
    #pixCode { margin-top: 10px; word-wrap: break-word; font-size: 14px; color: #333; }
    #status { margin-top: 15px; font-weight: bold; color: green; }
    #status.pending { color: orange; }
    #status.approved { color: green; }
    #status.rejected { color: red; }
  </style>
</head>
<body>
  <h1>Gerar PIX Produção</h1>

  <input type="number" id="amount" placeholder="Valor (R$)" step="0.01" />
  <button onclick="gerarPix()">Gerar QR</button>

  <div id="qr"></div>
  <p id="pixCode"></p>
  <p id="status"></p>
  <button id="copiar" style="display:none;" onclick="copiarPix()">Copiar Código PIX</button>

  <script>
    const customerEmail = "amorimmm60@gmail.com";
    let currentPaymentId = null;
    let statusInterval = null;

    async function gerarPix() {
      const amount = document.getElementById("amount").value;
      if (!amount) return alert("Digite um valor!");

      try {
        const res = await fetch("/create-pix", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount, description: "Pagamento VIP", email: customerEmail })
        });

        const data = await res.json();
        if (data.error) return alert("Erro: " + data.error);

        currentPaymentId = data.id;
        document.getElementById("qr").innerHTML = `<img src="data:image/png;base64,${data.qr_code_base64}" />`;
        document.getElementById("pixCode").innerText = data.qr_code;
        document.getElementById("copiar").style.display = "inline-block";

        if (statusInterval) clearInterval(statusInterval);
        setStatus("pending", "Aguardando pagamento...");

        // Polling do Supabase para status real
        statusInterval = setInterval(checkStatus, 3000);

      } catch (err) {
        alert("Erro ao gerar PIX: " + err.message);
      }
    }

    async function checkStatus() {
  if (!currentPaymentId) return;
  try {
    const res = await fetch(`/status-pix/${currentPaymentId}`);
    const data = await res.json();
    if (data.status === "approved") {
      setStatus("approved", "Pagamento aprovado ✅");
      clearInterval(statusInterval);
    } else {
      setStatus("pending", "Aguardando pagamento...");
    }
  } catch (err) {
    console.error("Erro ao checar status:", err);
  }
}


    function setStatus(className, text) {
      const statusEl = document.getElementById("status");
      statusEl.className = className || "";
      statusEl.innerText = text || "";
    }

    function copiarPix() {
      navigator.clipboard.writeText(document.getElementById("pixCode").innerText)
        .then(() => alert("Código PIX copiado!"))
        .catch(() => alert("Falha ao copiar."));
    }
  </script>
</body>
</html>

