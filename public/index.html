<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>PIX Mercado Pago Produção</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 400px; margin: 40px auto; text-align: center; }
    input, button { padding: 10px; margin: 10px; width: 90%; }
    #qr img { margin-top: 20px; max-width: 300px; }
    #pixCode { margin-top: 10px; word-wrap: break-word; font-size: 14px; color: #333; }
    #status { margin-top: 15px; font-weight: bold; color: green; }
    #status.pending { color: orange; }
    #status.approved { color: green; }
    #status.rejected { color: red; }
  </style>
</head>
<body>
  <h1>Gerar PIX Produção</h1>

  <input type="number" id="amount" placeholder="Valor (R$)" step="0.01" />
  <button onclick="gerarPix()">Gerar QR</button>

  <div id="qr"></div>
  <p id="pixCode"></p>
  <p id="status"></p>
  <button id="copiar" style="display:none;" onclick="copiarPix()">Copiar Código PIX</button>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = "<SUA_SUPABASE_URL>";
    const SUPABASE_KEY = "<SUA_SUPABASE_SERVICE_KEY>";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const customerEmail = "amorimmm60@gmail.com"; // email real do cliente
    let currentPaymentId = null;

    async function gerarPix() {
      const amount = document.getElementById("amount").value;
      if (!amount) return alert("Digite um valor!");

      try {
        const res = await fetch("/create-pix", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount, description: "Pagamento VIP", email: customerEmail })
        });
        const data = await res.json();
        if (data.error) return alert("Erro: " + data.error);

        currentPaymentId = data.id;

        document.getElementById("qr").innerHTML = `<img src="data:image/png;base64,${data.qr_code_base64}" />`;
        document.getElementById("pixCode").innerText = data.qr_code;
        document.getElementById("copiar").style.display = "inline-block";

        setStatus("pending", "Aguardando pagamento...");

        // Inscreve no Supabase Realtime para receber atualização de status
        supabase
          .channel('pagamento-updates')
          .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'pagamentos', filter: `id=eq.${currentPaymentId}` }, payload => {
            if (payload.new.status === "approved") {
              setStatus("approved", "Pagamento aprovado ✅");
            } else {
              setStatus("pending", "Aguardando pagamento...");
            }
          })
          .subscribe();

      } catch (err) {
        alert("Erro ao gerar PIX: " + err.message);
      }
    }

    function setStatus(className, text) {
      const statusEl = document.getElementById("status");
      statusEl.className = className || "";
      statusEl.innerText = text || "";
    }

    function copiarPix() {
      navigator.clipboard.writeText(document.getElementById("pixCode").innerText)
        .then(() => alert("Código PIX copiado!"))
        .catch(() => alert("Falha ao copiar."));
    }
  </script>
</body>
</html>
