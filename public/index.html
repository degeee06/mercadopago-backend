<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>PIX Mercado Pago Produção</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 400px; margin: 40px auto; text-align: center; }
    input, button { padding: 10px; margin: 10px; width: 90%; }
    #qr img { margin-top: 20px; max-width: 300px; }
    #pixCode { margin-top: 10px; word-wrap: break-word; font-size: 14px; color: #333; }
    #status { margin-top: 15px; font-weight: bold; color: green; }
  </style>
</head>
<body>
  <h1>Gerar PIX Produção</h1>

  <input type="number" id="amount" placeholder="Valor (R$)" step="0.01" />
  <button onclick="gerarPix()">Gerar QR</button>

  <div id="qr"></div>
  <p id="pixCode"></p>
  <p id="status"></p>
  <button id="copiar" style="display:none;" onclick="copiarPix()">Copiar Código PIX</button>

  <script>
    // Troque pelo email real do cliente
    const customerEmail = "amorimmm60@gmail.com"; 
    let currentPaymentId = null;
    let statusInterval = null;

    async function gerarPix() {
      const amount = document.getElementById("amount").value;
      if (!amount) return alert("Digite um valor!");

      try {
        const res = await fetch("/create-pix", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            amount, 
            description: "Pagamento VIP", 
            email: customerEmail 
          })
        });

        const data = await res.json();

        if (data.error) {
          alert("Erro: " + data.error);
          return;
        }

        currentPaymentId = data.id;

        // Exibe QR Code
        document.getElementById("qr").innerHTML = `<img src="data:image/png;base64,${data.qr_code_base64}" />`;

        // Mostra código PIX copia-e-cola
        document.getElementById("pixCode").innerText = data.qr_code;

        // Botão copiar visível
        document.getElementById("copiar").style.display = "inline-block";

        // Polling para status
        if (statusInterval) clearInterval(statusInterval);
        document.getElementById("status").innerText = "Aguardando pagamento...";
        statusInterval = setInterval(checkStatus, 3000);

      } catch (err) {
        alert("Erro ao gerar PIX: " + err.message);
      }
    }

    async function checkStatus() {
      if (!currentPaymentId) return;

      const res = await fetch(`/status-pix/${currentPaymentId}`);
      const data = await res.json();

      if (data.status === "approved") {
        document.getElementById("status").innerText = "Pagamento aprovado ✅";
        clearInterval(statusInterval);
      } else if (data.status === "rejected") {
        document.getElementById("status").innerText = "Pagamento recusado ❌";
        clearInterval(statusInterval);
      } else {
        document.getElementById("status").innerText = "Aguardando pagamento...";
      }
    }

    function copiarPix() {
      navigator.clipboard.writeText(document.getElementById("pixCode").innerText)
        .then(() => alert("Código PIX copiado!"))
        .catch(() => alert("Falha ao copiar."));
    }
  </script>
</body>
</html>

